language: c

compiler:
  - clang
  - gcc

env:
  - COVERAGE=yes CFLAGS=--coverage LDFLAGS=--coverage FEATURES=huge SHADOWOPT="-C src/shadow" SHADOW=./src/shadow
    "CONFOPT='--enable-perlinterp --enable-pythoninterp --enable-python3interp --enable-rubyinterp --enable-luainterp'"
  - COVERAGE=no FEATURES=small CONFOPT= SHADOWOPT= SHADOW=./src
  - COVERAGE=no FEATURES=tiny  CONFOPT= SHADOWOPT= SHADOW=./src

sudo: false

branches:
  except:
    - /^v[0-9]/

addons:
  apt:
    packages:
      - lcov
      - libperl-dev
      - python-dev
      - python3-dev
      - liblua5.1-0-dev
      - lua5.1

before_install:
  - pip install --user cpp-coveralls

script:
  - NPROC=$(getconf _NPROCESSORS_ONLN)
  - if [ "x$SHADOWOPT" != x ]; then make -C src shadow; fi && (cd ${SHADOW} && ./configure --with-features=$FEATURES $CONFOPT --enable-fail-if-missing && make -j$NPROC)
  - ${SHADOW}/vim --version
  - make $SHADOWOPT test

after_success:
  - if [ x"$COVERAGE" = "xyes" ]; then ~/.local/bin/coveralls -b $SHADOW -x .xs -e ${SHADOW}/xxd -e ${SHADOW}/if_perl.c --encodings utf-8 latin-1 EUC-KR; fi

# vim:set sts=2 sw=2 tw=0 et:
